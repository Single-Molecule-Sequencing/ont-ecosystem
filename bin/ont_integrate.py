#!/usr/bin/env python3
"""
ONT Integration System - Automated Repository Connection and Sync

This script provides seamless integration between:
- ont-ecosystem (core hub)
- SMS_textbook content (now internal)
- Independent manuscript repositories

Features:
- Create connected manuscript repos from templates
- Auto-sync figures/tables to manuscripts
- Manage git submodule connections
- Verify integration health

Part of: https://github.com/Single-Molecule-Sequencing/ont-ecosystem

Usage:
    ont_integrate.py create-manuscript <name> [--template paper]
    ont_integrate.py connect <manuscript_path>
    ont_integrate.py sync <manuscript_path>
    ont_integrate.py status
"""

import argparse
import json
import os
import shutil
import subprocess
import sys
from datetime import datetime
from pathlib import Path

# Optional imports
try:
    import yaml
    HAS_YAML = True
except ImportError:
    HAS_YAML = False


# =============================================================================
# Configuration
# =============================================================================

ECOSYSTEM_ROOT = Path(__file__).parent.parent
TEXTBOOK_DIR = ECOSYSTEM_ROOT / "textbook"
MANUSCRIPTS_DIR = ECOSYSTEM_ROOT / "manuscripts"
TEMPLATES_DIR = MANUSCRIPTS_DIR / "templates"
REGISTRY_DIR = ECOSYSTEM_ROOT / "registry"

# GitHub configuration
GITHUB_ORG = "Single-Molecule-Sequencing"
ECOSYSTEM_REPO = f"git@github.com:{GITHUB_ORG}/ont-ecosystem.git"


# =============================================================================
# Template Definitions
# =============================================================================

MANUSCRIPT_TEMPLATES = {
    "paper": {
        "description": "Standard research paper",
        "structure": {
            "manuscript.tex": "main",
            "abstract.tex": "section",
            "introduction.tex": "section",
            "methods.tex": "section",
            "results.tex": "section",
            "discussion.tex": "section",
            "references.bib": "bib",
            "figures/": "dir",
            "tables/": "dir",
            "supplementary/": "dir",
        },
        "submodule_path": "ont-ecosystem",
        "inherit_files": ["sms.sty", "references.bib"],
    },
    "chapter": {
        "description": "Textbook chapter",
        "structure": {
            "chapter.tex": "main",
            "content.tex": "section",
            "equations.tex": "section",
            "examples.tex": "section",
            "exercises.tex": "section",
            "figures/": "dir",
            "tables/": "dir",
        },
        "submodule_path": "ont-ecosystem",
        "inherit_files": ["sms.sty", "equation_framework_v2.tex"],
    },
    "supplement": {
        "description": "Supplementary materials",
        "structure": {
            "supplement.tex": "main",
            "extended_methods.tex": "section",
            "additional_figures/": "dir",
            "data_tables/": "dir",
        },
        "submodule_path": "ont-ecosystem",
        "inherit_files": ["sms.sty"],
    },
}


# =============================================================================
# Template Content
# =============================================================================

def get_main_tex_content(name: str, template_type: str) -> str:
    """Generate main .tex file content"""
    if template_type == "paper":
        return f"""% {name} - Research Paper
% Generated by ONT Ecosystem - ont_integrate.py
% Date: {datetime.now().strftime("%Y-%m-%d")}

\\documentclass[11pt]{{article}}

% Import shared style from ont-ecosystem
\\usepackage{{ont-ecosystem/textbook/sms}}

% Packages
\\usepackage{{graphicx}}
\\usepackage{{amsmath}}
\\usepackage{{booktabs}}
\\usepackage{{hyperref}}

\\title{{{name}}}
\\author{{SMS Lab}}
\\date{{\\today}}

\\begin{{document}}

\\maketitle

\\input{{abstract}}
\\input{{introduction}}
\\input{{methods}}
\\input{{results}}
\\input{{discussion}}

\\bibliographystyle{{plain}}
\\bibliography{{references,ont-ecosystem/textbook/references}}

\\end{{document}}
"""
    elif template_type == "chapter":
        return f"""% {name} - Textbook Chapter
% Generated by ONT Ecosystem - ont_integrate.py
% Date: {datetime.now().strftime("%Y-%m-%d")}

\\documentclass[../main.tex]{{subfiles}}

% Import shared style from ont-ecosystem
\\usepackage{{ont-ecosystem/textbook/sms}}

\\begin{{document}}

\\chapter{{{name}}}
\\label{{chap:{name.lower().replace(' ', '_')}}}

\\input{{content}}
\\input{{equations}}
\\input{{examples}}
\\input{{exercises}}

\\end{{document}}
"""
    else:  # supplement
        return f"""% {name} - Supplementary Materials
% Generated by ONT Ecosystem - ont_integrate.py

\\documentclass[11pt]{{article}}
\\usepackage{{ont-ecosystem/textbook/sms}}

\\title{{Supplementary Materials: {name}}}
\\date{{\\today}}

\\begin{{document}}
\\maketitle

\\input{{extended_methods}}

\\end{{document}}
"""


def get_section_tex_content(section_name: str) -> str:
    """Generate section .tex file content"""
    section_title = section_name.replace("_", " ").title()
    return f"""% {section_title}
% Edit this file to add content

\\section{{{section_title}}}
\\label{{sec:{section_name}}}

% Add your content here

"""


def get_gitignore_content() -> str:
    """Generate .gitignore for manuscript"""
    return """# LaTeX build files
*.aux
*.bbl
*.blg
*.fdb_latexmk
*.fls
*.log
*.out
*.synctex.gz
*.toc
*.lof
*.lot

# PDF output (optional - uncomment to track)
# *.pdf

# Editor files
*.swp
*~
.DS_Store

# Build directories
build/
_minted-*/
"""


def get_manuscript_claude_md(name: str, template_type: str) -> str:
    """Generate CLAUDE.md for manuscript"""
    return f"""# CLAUDE.md - {name}

This manuscript is connected to the ONT Ecosystem.

## Connection

This repository uses ont-ecosystem as a git submodule:
- Submodule path: `ont-ecosystem/`
- Equations: `ont-ecosystem/textbook/equations.yaml`
- Variables: `ont-ecosystem/textbook/variables.yaml`
- Style: `ont-ecosystem/textbook/sms.sty`

## Commands

```bash
# Update submodule to latest
git submodule update --remote

# Generate figures from experiments
cd ont-ecosystem && python bin/ont_manuscript.py figure fig_end_reason_kde <exp_id>

# Sync figures to this manuscript
python ont-ecosystem/bin/ont_integrate.py sync .

# Build PDF
latexmk -pdf manuscript.tex
```

## Structure

Template: {template_type}
Created: {datetime.now().strftime("%Y-%m-%d")}

## Equation References

To reference equations from the textbook:
```latex
% In your .tex file
From Equation~\\ref{{eq:phred_to_error}} in the SMS Framework...
```

See `ont-ecosystem/textbook/equations.yaml` for all available equations.
"""


def get_makefile_content(name: str) -> str:
    """Generate Makefile for manuscript"""
    main_file = "manuscript" if "paper" in name.lower() else "chapter"
    return f"""# Makefile for {name}
# Generated by ONT Ecosystem

MAIN = {main_file}
LATEX = pdflatex
BIBTEX = bibtex

.PHONY: all clean update-submodule sync-figures

all: $(MAIN).pdf

$(MAIN).pdf: $(MAIN).tex
\t$(LATEX) $(MAIN)
\t$(BIBTEX) $(MAIN) || true
\t$(LATEX) $(MAIN)
\t$(LATEX) $(MAIN)

clean:
\trm -f *.aux *.bbl *.blg *.log *.out *.toc *.lof *.lot *.synctex.gz

update-submodule:
\tgit submodule update --remote ont-ecosystem

sync-figures:
\tpython ont-ecosystem/bin/ont_integrate.py sync .
"""


# =============================================================================
# Manuscript Creation
# =============================================================================

def create_manuscript(name: str, template_type: str = "paper",
                      output_dir: Path = None, init_git: bool = True) -> Path:
    """
    Create a new manuscript repository with ont-ecosystem connection.

    Args:
        name: Manuscript name
        template_type: Template to use (paper, chapter, supplement)
        output_dir: Where to create (default: manuscripts/<name>)
        init_git: Initialize git repo

    Returns:
        Path to created manuscript
    """
    if template_type not in MANUSCRIPT_TEMPLATES:
        print(f"Error: Unknown template: {template_type}")
        print(f"Available: {', '.join(MANUSCRIPT_TEMPLATES.keys())}")
        return None

    template = MANUSCRIPT_TEMPLATES[template_type]

    # Determine output path
    if output_dir is None:
        output_dir = MANUSCRIPTS_DIR / name.lower().replace(" ", "-")
    else:
        output_dir = Path(output_dir)

    if output_dir.exists():
        print(f"Error: Directory already exists: {output_dir}")
        return None

    print(f"Creating manuscript: {name}")
    print(f"  Template: {template_type}")
    print(f"  Location: {output_dir}")

    # Create directory structure
    output_dir.mkdir(parents=True, exist_ok=True)

    for path, path_type in template["structure"].items():
        full_path = output_dir / path

        if path_type == "dir":
            full_path.mkdir(parents=True, exist_ok=True)
            # Add .gitkeep
            (full_path / ".gitkeep").touch()
        elif path_type == "main":
            content = get_main_tex_content(name, template_type)
            full_path.write_text(content)
        elif path_type == "section":
            section_name = path.replace(".tex", "")
            content = get_section_tex_content(section_name)
            full_path.write_text(content)
        elif path_type == "bib":
            # Create empty bib file with header
            content = f"% Bibliography for {name}\n% Add your references here\n\n"
            full_path.write_text(content)

    # Create support files
    (output_dir / ".gitignore").write_text(get_gitignore_content())
    (output_dir / "CLAUDE.md").write_text(get_manuscript_claude_md(name, template_type))
    (output_dir / "Makefile").write_text(get_makefile_content(name))

    # Create README
    readme = f"""# {name}

{template['description']}

## Setup

```bash
# Clone with submodule
git clone --recursive <this-repo-url>

# Or if already cloned
git submodule update --init
```

## Build

```bash
make        # Build PDF
make clean  # Clean build files
```

## Connection to ONT Ecosystem

This manuscript is connected to [ont-ecosystem](https://github.com/{GITHUB_ORG}/ont-ecosystem).

- Equations: `ont-ecosystem/textbook/equations.yaml`
- Figures: Generated via `ont_manuscript.py`
- Style: `ont-ecosystem/textbook/sms.sty`

## Sync Figures

```bash
# Update from ont-ecosystem
make update-submodule
make sync-figures
```
"""
    (output_dir / "README.md").write_text(readme)

    # Initialize git if requested
    if init_git:
        print("  Initializing git repository...")
        subprocess.run(["git", "init"], cwd=output_dir, capture_output=True)

        # Add ont-ecosystem as submodule
        print("  Adding ont-ecosystem submodule...")
        subprocess.run([
            "git", "submodule", "add",
            ECOSYSTEM_REPO,
            "ont-ecosystem"
        ], cwd=output_dir, capture_output=True)

        # Initial commit
        subprocess.run(["git", "add", "."], cwd=output_dir, capture_output=True)
        subprocess.run([
            "git", "commit", "-m",
            f"Initial manuscript structure: {name}\n\nGenerated by ONT Ecosystem ont_integrate.py"
        ], cwd=output_dir, capture_output=True)

    print(f"\nManuscript created successfully!")
    print(f"\nNext steps:")
    print(f"  cd {output_dir}")
    print(f"  # Edit your .tex files")
    print(f"  make  # Build PDF")

    return output_dir


# =============================================================================
# Manuscript Sync
# =============================================================================

def sync_manuscript(manuscript_path: Path, experiments: list = None) -> dict:
    """
    Sync figures and tables from ont-ecosystem to manuscript.

    Args:
        manuscript_path: Path to manuscript repo
        experiments: Optional list of experiment IDs to sync

    Returns:
        Dict with sync results
    """
    manuscript_path = Path(manuscript_path)
    results = {
        "figures_synced": [],
        "tables_synced": [],
        "errors": [],
    }

    # Check for ont-ecosystem submodule
    submodule_path = manuscript_path / "ont-ecosystem"
    if not submodule_path.exists():
        results["errors"].append("ont-ecosystem submodule not found")
        return results

    # Get artifacts directory
    artifacts_dir = Path.home() / ".ont-manuscript" / "artifacts"
    if not artifacts_dir.exists():
        results["errors"].append("No artifacts found in ~/.ont-manuscript/artifacts")
        return results

    # Determine which experiments to sync
    if experiments is None:
        # Sync all available experiments
        experiments = [d.name for d in artifacts_dir.iterdir() if d.is_dir()]

    # Sync figures
    figures_dest = manuscript_path / "figures"
    figures_dest.mkdir(exist_ok=True)

    for exp_id in experiments:
        exp_dir = artifacts_dir / exp_id / "figures"
        if exp_dir.exists():
            for fig_dir in exp_dir.iterdir():
                if fig_dir.is_dir():
                    latest = fig_dir / "latest"
                    if latest.exists():
                        for fig_file in latest.iterdir():
                            if fig_file.suffix in (".pdf", ".png"):
                                dest = figures_dest / fig_file.name
                                shutil.copy(fig_file, dest)
                                results["figures_synced"].append(str(dest))

    # Sync tables
    tables_dest = manuscript_path / "tables"
    tables_dest.mkdir(exist_ok=True)

    for exp_id in experiments:
        exp_dir = artifacts_dir / exp_id / "tables"
        if exp_dir.exists():
            for tbl_dir in exp_dir.iterdir():
                if tbl_dir.is_dir():
                    latest = tbl_dir / "latest"
                    if latest.exists():
                        for tbl_file in latest.iterdir():
                            if tbl_file.suffix in (".tex", ".csv"):
                                dest = tables_dest / tbl_file.name
                                shutil.copy(tbl_file, dest)
                                results["tables_synced"].append(str(dest))

    return results


def connect_manuscript(manuscript_path: Path) -> bool:
    """
    Connect an existing manuscript to ont-ecosystem.

    Args:
        manuscript_path: Path to existing manuscript

    Returns:
        True if successful
    """
    manuscript_path = Path(manuscript_path)

    if not manuscript_path.exists():
        print(f"Error: Manuscript not found: {manuscript_path}")
        return False

    # Check if already connected
    submodule_path = manuscript_path / "ont-ecosystem"
    if submodule_path.exists():
        print("Manuscript already connected to ont-ecosystem")
        return True

    # Add submodule
    print(f"Connecting {manuscript_path} to ont-ecosystem...")
    result = subprocess.run([
        "git", "submodule", "add",
        ECOSYSTEM_REPO,
        "ont-ecosystem"
    ], cwd=manuscript_path, capture_output=True, text=True)

    if result.returncode != 0:
        print(f"Error: {result.stderr}")
        return False

    # Create CLAUDE.md if not exists
    claude_path = manuscript_path / "CLAUDE.md"
    if not claude_path.exists():
        claude_path.write_text(get_manuscript_claude_md(
            manuscript_path.name, "paper"
        ))

    print("Successfully connected!")
    return True


# =============================================================================
# Status Check
# =============================================================================

def check_status() -> dict:
    """
    Check integration status of all components.

    Returns:
        Dict with status info
    """
    status = {
        "ecosystem": {
            "path": str(ECOSYSTEM_ROOT),
            "textbook_present": TEXTBOOK_DIR.exists(),
            "equations_lines": 0,
            "variables_lines": 0,
        },
        "manuscripts": [],
        "artifacts": {
            "path": str(Path.home() / ".ont-manuscript" / "artifacts"),
            "experiments": 0,
            "figures": 0,
            "tables": 0,
        },
    }

    # Check textbook
    if TEXTBOOK_DIR.exists():
        eq_file = TEXTBOOK_DIR / "equations.yaml"
        var_file = TEXTBOOK_DIR / "variables.yaml"
        if eq_file.exists():
            status["ecosystem"]["equations_lines"] = sum(1 for _ in open(eq_file))
        if var_file.exists():
            status["ecosystem"]["variables_lines"] = sum(1 for _ in open(var_file))

    # Check manuscripts
    if MANUSCRIPTS_DIR.exists():
        for item in MANUSCRIPTS_DIR.iterdir():
            if item.is_dir() and not item.name.startswith("."):
                ms_info = {
                    "name": item.name,
                    "path": str(item),
                    "connected": (item / "ont-ecosystem").exists(),
                    "has_git": (item / ".git").exists(),
                }
                status["manuscripts"].append(ms_info)

    # Check artifacts
    artifacts_dir = Path.home() / ".ont-manuscript" / "artifacts"
    if artifacts_dir.exists():
        for exp_dir in artifacts_dir.iterdir():
            if exp_dir.is_dir():
                status["artifacts"]["experiments"] += 1
                figs = exp_dir / "figures"
                tbls = exp_dir / "tables"
                if figs.exists():
                    status["artifacts"]["figures"] += len(list(figs.iterdir()))
                if tbls.exists():
                    status["artifacts"]["tables"] += len(list(tbls.iterdir()))

    return status


# =============================================================================
# CLI Commands
# =============================================================================

def cmd_create(args):
    """Create new manuscript"""
    result = create_manuscript(
        args.name,
        template_type=args.template,
        output_dir=Path(args.output) if args.output else None,
        init_git=not args.no_git
    )
    if result is None:
        sys.exit(1)


def cmd_connect(args):
    """Connect existing manuscript"""
    if not connect_manuscript(Path(args.manuscript_path)):
        sys.exit(1)


def cmd_sync(args):
    """Sync figures/tables to manuscript"""
    results = sync_manuscript(
        Path(args.manuscript_path),
        experiments=args.experiments
    )

    print(f"Synced {len(results['figures_synced'])} figures")
    print(f"Synced {len(results['tables_synced'])} tables")

    if results["errors"]:
        print(f"\nErrors:")
        for err in results["errors"]:
            print(f"  - {err}")
        sys.exit(1)


def cmd_status(args):
    """Show integration status"""
    status = check_status()

    print("ONT Ecosystem Integration Status")
    print("=" * 50)

    print(f"\nCore Ecosystem:")
    print(f"  Path: {status['ecosystem']['path']}")
    print(f"  Textbook: {'Present' if status['ecosystem']['textbook_present'] else 'Missing'}")
    print(f"  Equations: {status['ecosystem']['equations_lines']} lines")
    print(f"  Variables: {status['ecosystem']['variables_lines']} lines")

    print(f"\nManuscripts ({len(status['manuscripts'])}):")
    for ms in status["manuscripts"]:
        connected = "connected" if ms["connected"] else "not connected"
        print(f"  - {ms['name']}: {connected}")

    print(f"\nArtifacts:")
    print(f"  Experiments: {status['artifacts']['experiments']}")
    print(f"  Figures: {status['artifacts']['figures']}")
    print(f"  Tables: {status['artifacts']['tables']}")

    if args.json:
        print("\n" + json.dumps(status, indent=2))


def cmd_list_templates(args):
    """List available templates"""
    print("Available Manuscript Templates:")
    print()
    for name, info in MANUSCRIPT_TEMPLATES.items():
        print(f"  {name}")
        print(f"    {info['description']}")
        print(f"    Files: {', '.join(info['structure'].keys())}")
        print()


def main():
    parser = argparse.ArgumentParser(
        description="ONT Integration System - Repository Connection and Sync",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Create a new paper manuscript
  ont_integrate.py create-manuscript "CYP2D6 Analysis" --template paper

  # Create a textbook chapter
  ont_integrate.py create-manuscript "Chapter 21 End Reason" --template chapter

  # Connect existing manuscript
  ont_integrate.py connect /path/to/manuscript

  # Sync figures to manuscript
  ont_integrate.py sync /path/to/manuscript

  # Check status
  ont_integrate.py status
"""
    )

    subparsers = parser.add_subparsers(dest="command", help="Commands")

    # create-manuscript
    p_create = subparsers.add_parser("create-manuscript", help="Create new manuscript")
    p_create.add_argument("name", help="Manuscript name")
    p_create.add_argument("--template", "-t", default="paper",
                         choices=list(MANUSCRIPT_TEMPLATES.keys()),
                         help="Template type")
    p_create.add_argument("--output", "-o", help="Output directory")
    p_create.add_argument("--no-git", action="store_true", help="Skip git init")
    p_create.set_defaults(func=cmd_create)

    # connect
    p_connect = subparsers.add_parser("connect", help="Connect existing manuscript")
    p_connect.add_argument("manuscript_path", help="Path to manuscript")
    p_connect.set_defaults(func=cmd_connect)

    # sync
    p_sync = subparsers.add_parser("sync", help="Sync figures/tables to manuscript")
    p_sync.add_argument("manuscript_path", help="Path to manuscript")
    p_sync.add_argument("--experiments", "-e", nargs="+", help="Specific experiments to sync")
    p_sync.set_defaults(func=cmd_sync)

    # status
    p_status = subparsers.add_parser("status", help="Show integration status")
    p_status.add_argument("--json", action="store_true", help="Output as JSON")
    p_status.set_defaults(func=cmd_status)

    # templates
    p_templates = subparsers.add_parser("templates", help="List available templates")
    p_templates.set_defaults(func=cmd_list_templates)

    args = parser.parse_args()

    if args.command is None:
        parser.print_help()
    else:
        args.func(args)


if __name__ == "__main__":
    main()
